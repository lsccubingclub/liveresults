<!DOCTYPE html>
<html>
<head>
  <title>LSC Cubing Club</title>
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://i.imgur.com/rrfbu9P.png"
  />

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    #view-home #main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;  /* logo left, title center, icon right */
      padding: 20px 40px;
      position: sticky;
      top: 0;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    #view-home #main-header.shrink {
      padding: 10px 30px;
      font-size: 0.6em;
    }

    #view-home #logo {
      height: 50px;
      transition: height 0.3s ease;
    }

    #view-home #main-header.shrink #logo {
      height: 35px;
    }

    #view-home .ig-link img {
      height: 24px;
      display: block;
      cursor: pointer;
    }

    .social-icons img {
      height: 24px;
      cursor: pointer;
    }

    /* Optional: keep the title from wrapping awkwardly on small screens */
    #view-home #club-name {
      margin: 0 auto;
      font-size: 30px;
      text-align: center;
      white-space: nowrap;
    }

    body { font-family: 'Roboto', sans-serif; background: #f4f4f4; padding: 20px; }

    .title-banner { background-color: #1976D2; color: white; padding: 15px; margin-bottom: 10px; text-align: left; }
    
    h1 { margin: 0; font-size: 28px; }

    #subtitle { font-size: 20px; color: #000; text-align: left; margin: 10px auto 20px; max-width: 98%; }
   
    #dropdown-container { text-align: left; margin: 10px auto 20px; max-width: 98%; font-size: 16px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
   
    select { padding: 6px 10px; font-size: 15px; border-radius: 4px; border: 1px solid #ccc; background-color: #ffffff; color: black; }
   
    table { margin: auto; border-collapse: collapse; width: 98%; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow-x: auto; }
    
    th, td { padding: 8px; border-bottom: 1px solid #ddd; font-size: 13px; }
    
    th { background-color: #1976D2; color: white; position: sticky; top: 0; text-align: center; }
    
    tr:hover { background-color: #f1f1f1; }
    
    #editor-panel input { width: 100%; box-sizing: border-box; padding: 4px 6px; font-size: 13px; }
    
    .btn { font-weight: bold; background-color:#ffffff; color:black; border:1px solid black; padding:6px 9px; border-radius:4px; font-size:14px; cursor: pointer; }
    
    .btn:hover { background-color: #dddddd; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); }
    
    select:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>

  <!-- Firebase (Auth only) -->
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
</head>
<body>


  <!-- ADDED: Home view -->
  <main id="view-home" hidden>
    <!-- Sticky Header -->
    <header id="main-header">
      <img
        id="logo"
        src="https://i.imgur.com/rrfbu9P.png"
        alt="Club Logo"
      />

      <h1 id="club-name">LSC Cubing Club</h1>

      <div class="social-icons">
        <a
          href="https://instagram.com/lsccubingclub"
          target="_blank"
          aria-label="Instagram"
        >
          <img
            src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png"
            alt="Instagram"
          />
        </a>
      </div>
    </header>


    <!-- Main Content -->
    <section style="padding:40px 20px; max-width:800px; margin:auto;">
      <!-- Live Button -->
      <div class="section">
        <h2 style="color:#1976D2;">Live Results</h2>
        <a href="/live" class="btn-live" style="
          display:inline-block;
          padding:12px 24px;
          background:#1976D2;
          color:white;
          border-radius:6px;
          font-weight:bold;
          margin-top:12px;
        ">Go to LSC Cubing Club Live</a>
      </div>

      <!-- Upcoming Events -->
      <div class="section" style="margin-top:40px;">
        <h2 style="color:#1976D2;">Upcoming Events</h2>
        <ul class="events" style="list-style:none; padding-left:0;">
          <li style="background:white; padding:12px 16px; margin-bottom:8px; border-left:4px solid #1976D2; box-shadow:0 1px 3px rgba(0,0,0,0.1);">Annual General Meeting - Oct 2025</li>
          <li style="background:white; padding:12px 16px; margin-bottom:8px; border-left:4px solid #1976D2; box-shadow:0 1px 3px rgba(0,0,0,0.1);">First Term Healthy Lifestyle Week - Oct 2025</li>
          <li style="background:white; padding:12px 16px; margin-bottom:8px; border-left:4px solid #1976D2; box-shadow:0 1px 3px rgba(0,0,0,0.1);">LSC All-Stars 2025 – Nov 2025</li>
        </ul>
        <a href="/events" class="btn-live" style="
          display:inline-block;
          padding:12px 24px;
          background:#1976D2;
          color:white;
          border-radius:6px;
          font-weight:bold;
          margin-top:12px;
        ">View all upcoming events</a>
      </div>

      <!-- About Us -->
      <div class="section" style="margin-top:40px;">
        <h2 style="color:#1976D2;">About Us</h2>
        <p>
            The LSC Cubing Club is a passionate community of speedcubers based in Hong Kong. We host regular competitions, workshops, and meetups to promote the art and science of cubing. Whether you're a beginner or a seasoned solver, you'll find a place here to grow, compete, and connect.
        </p>
      </div>
    </section>

    <!-- Footer -->
    <footer style="text-align:center; padding:20px; font-size:0.9em; color:#666;">
      created by lai
    </footer>

    <!-- Shrink Header Script -->
    <script>
      const header = document.getElementById('main-header');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 30) {
          header.classList.add('shrink');
        } else {
          header.classList.remove('shrink');
        }
      });
    </script>

    <!-- Shrink Header Styles -->
    <style>
      header {
        position: sticky;
        top: 0;
        background: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 40px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      header.shrink {
        padding: 10px 30px;
        font-size: 0.9em;
      }

      #logo {
        height: 50px;
        transition: height 0.3s ease;
      }

      header.shrink #logo {
        height: 35px;
      }

      .social-icons img {
        height: 24px;
        cursor: pointer;
      }
    </style>
  </main>

  <main id="view-events" hidden>
    <div style="padding:40px 20px; max-width:800px; margin:auto;">
      <button class="btn" onclick="navigate('/')">← Home</button>

      <h2 style="color:#1976D2; margin-top:20px;">Upcoming Events</h2>
      <ul id="events-list" style="list-style:none; padding:0; margin:0;">
        <!-- JS will populate this -->
      </ul>

      <div id="event-details" style="margin-top:24px; background:white; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:none;">
        <!-- JS will inject details here -->
      </div>
    </div>
  </main>

  <main id="view-live" hidden>
    <div class="title-banner">
      <h1 id="page-title">LSC Cubing Club Live</h1>
    </div>
    <div style="margin-bottom:12px;">
      <button id="go-home" class="btn">Back</button>
    </div>
    <div id="login-panel" style="text-align:right; display:none;">
      <input type="email" id="email" placeholder="Email"><br>
      <input type="password" id="password" placeholder="Password"><br>
      <button onclick="login()" class="btn">SIGN IN</button>
    </div>
    <div id="login-status" style="margin-top:10px; transition: opacity 0.5s;"></div>
    
    <div><p id="submit-status" style="display:none"></p></div>

    <div id="dropdown-container">
      <label for="comp-select"></label>
      <select id="comp-select"></select>

      <label for="round-select"></label>
      <select id="round-select"></select>
    </div>

    <div id="subtitle"></div>
    <div id="loading-message" style="display:block; margin-left: 10px; margin-bottom:5px"></div>

    <table id="leaderboard">
      <thead></thead>
      <tbody></tbody>
    </table>

    <div id="editor-panel" style="display:none; margin-top:20px;">
      <h3>Input live results</h3>
      <div style="margin-bottom:8px; font-size:13px; color:#555;">
        Inputting live results for <span id="editing-sheet-name"></span>
      </div>
      <table id="edit-table"><thead></thead><tbody></tbody></table>
      <div style="margin-top:10px; display: flex; gap: 10px;">
        <button onclick="submitEdits()" class="btn">Confirm</button>
        <button onclick="cancelEdit()" class="btn">Cancel</button>
      </div>
    </div>
  </main>

  <script>

    document.getElementById('go-home').onclick = () => {
      navigate('/');       // pushes "/" into history and re-renders, showing Home
    };

    // convert “Foo Bar” → “Foo_Bar”
    function slug(str) {
      return encodeURIComponent(str.trim().replace(/\s+/g, '_'));
    }

    // convert “Foo_Bar” → “Foo Bar”
    function unslug(str) {
      return decodeURIComponent(str).replace(/_/g, ' ');
    }
    
    // ===== Path helpers =====
    function toPath(comp = "", round = "") {
      let p = "/live";
      if (comp) p += `/${slug(comp)}`;
      if (round) p += `/${slug(round)}`;
      return p;
    }

    function navigate(path) {
      history.pushState({}, '', path); // user-initiated navigation
      render();
    }

    // Put this near your other helpers
    function updateTitles() {
      const h1 = document.getElementById('page-title');
      if (h1) h1.textContent = currentComp || 'LSC All-Stars 2025';
      document.title = currentComp ? `${currentComp} — Live` : 'LSC Cubing Club Live';
    }

    // ===== Routing =====
    function getRoute() {
      const parts = window.location.pathname.split('/').map(decodeURIComponent);
      const page = parts[1] || '';      // ← define page here
      return {
        isHome:   page === '',
        isLive:   page === 'live',
        isEvents: page === 'events',
        comp: parts[2] ? unslug(parts[2]) : '',
        round: parts[3] ? unslug(parts[3]) : ''
      };
    }

    function showView(id) {
      document.getElementById('view-home').hidden = id !== 'home';
      document.getElementById('view-live').hidden = id !== 'live';
      document.getElementById('view-events').hidden = id !== 'events';
    }

    // Replace during programmatic sync (avoid backstack spam)
    function navigateTo(comp = '', round = '') {
      let path = '/live';
      if (comp) path += `/${encodeURIComponent(comp)}`;
      if (round) path += `/${encodeURIComponent(round)}`;
      history.replaceState({}, '', path);
    }

    function syncURLWithState() {
      if (!currentComp) return navigateTo();
      if (!currentRound) return navigateTo(currentComp);
      navigateTo(currentComp, currentRound);
    }

    window.addEventListener('popstate', render);

    // ===== Auth =====
    let isLoggedIn = false;
    const firebaseConfig = {
      apiKey: "AIzaSyDUMb1cAuCzRwDfLipld8YrNX-WG4a7P2s",
      authDomain: "lsccubingclub-ebd29.firebaseapp.com",
      projectId: "lsccubingclub-ebd29",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ====== Login UI ======
    function showLogin() {
      document.getElementById('login-panel').style.display = 'block';
    }

    function login() {
      const email     = document.getElementById('email').value;
      const password  = document.getElementById('password').value;
      const statusMsg = document.getElementById('login-status');

      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          isLoggedIn = true;
          statusMsg.textContent = `Signed in as ${userCredential.user.email}`;
          statusMsg.style.color = 'green';
          statusMsg.style.opacity = 1;

          // hide panel after sign-in
          document.getElementById('login-panel').style.display = 'none';
          setTimeout(() => {
            statusMsg.style.opacity = 0;
          }, 3000);
        })
        .catch(error => {
          alert(`Login failed: ${error.message}`);
        });
    }

    // ====== Keyboard shortcut to open login ======
    document.addEventListener('keydown', e => {
      const isMac     = navigator.platform.toUpperCase().includes('MAC');
      const isShortcut= isMac ? e.metaKey : e.ctrlKey;
      if (isShortcut && e.key.toLowerCase() === 'l') {
        e.preventDefault();
        showLogin();
      }
    });

    // ====== Ctrl+E: show/hide editor panel ======
    document.addEventListener('keydown', function(e) {
      const isMac     = navigator.platform.toUpperCase().includes('MAC');
      const isShortcut= isMac ? e.metaKey : e.ctrlKey;
      if (!isShortcut || e.key.toLowerCase() !== 'e') return;

      e.preventDefault();

      if (isLoggedIn) {
        // hide login (if open) and dropdowns
        document.getElementById('login-panel').style.display      = 'none';
        document.getElementById('dropdown-container').style.display = 'none';
        // show editor
        document.getElementById('editor-panel').style.display     = 'block';
        // update the sheet name in the editor header
        document.getElementById('editing-sheet-name').textContent = currentSheetName || currentRound;
        // load the CSV into the edit table
        loadEditableSheet();
      } else {
        alert('Please sign in to input live results.');
      }
    });


    // ===== Config =====
    const MASTER_SHEET_ID = '1fjWyEbc7a5A3RjkFm0BEnE_lyHXCa3kYiKRd2IP9j5Q'; // master sheet (competitions/rounds)
    const API_KEY = 'AIzaSyA_4BKwiXfv_T9XhbdenwHuGm0k5uc89S8';             // ← replace if needed
    // Proxies to your Apps Script deployment (you already updated read.js/write.js)
    const READ_ENDPOINT = '/.netlify/functions/read';
    const WRITE_ENDPOINT = '/.netlify/functions/write';

    // ===== State =====
    let masterValues = [];   // A1:Z? matrix from master
    let currentComp = '';
    let currentRound = '';
    let currentSheetName = ''; // subtitle/editor label
    let initLiveDone = false;
    let currentFetchAbort;   // shared abort controller (prevents stale responses)

    // ===== Master sheet fetch (competitions + rounds) =====
    async function fetchMaster() {
      const tab   = 'config'; // ← change this to your real tab name
      const range = 'A1:Z20'; // ← narrow or widen as needed
      const url   =
        `https://sheets.googleapis.com/v4/spreadsheets/${MASTER_SHEET_ID}` +
        `/values/${encodeURIComponent(tab + '!' + range)}?key=${API_KEY}`;

      const res = await fetch(url);
      if (!res.ok) {
        console.error('Master sheet fetch failed', res.status, await res.text());
        return;
      }

      const json = await res.json();
      masterValues = json.values || [];

      if (!masterValues.length) {
        console.error('No values in master sheet—check your range/tab name');
        return;
      }

      populateCompetitions();
    }

    function populateCompetitions() {
      const comps = (masterValues[0] || []).slice(1); // row 1, skip col A
      const compSel = document.getElementById('comp-select');
      compSel.innerHTML = '';
      comps.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        compSel.appendChild(opt);
      });
      // defaults only; global handler will handle events
      populateRounds();
    }

    function populateRounds() {
      const compSel = document.getElementById('comp-select');
      currentComp = compSel.value;

      const compIndex = (masterValues[0] || []).indexOf(currentComp);
      const rounds = masterValues.slice(2).map(r => r[compIndex]).filter(Boolean);

      const roundSel = document.getElementById('round-select');
      roundSel.innerHTML = '';
      rounds.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        roundSel.appendChild(opt);
      });

      // set defaults
      if (rounds.length) {
        currentRound = rounds[0];
        currentSheetName = `${currentRound}`;
        document.getElementById('subtitle').textContent = currentSheetName;
        updateTitles(); 
      }
    }

    // ===== URL -> UI and data =====
    async function initLiveOnce() {
      if (initLiveDone) return;
      initLiveDone = true;
      await fetchMaster(); // must populate comp/round selects from the master sheet
    }

    function applyURLToUIAndData() {
      const { comp, round } = getRoute();
      const compSel = document.getElementById('comp-select');
      const roundSel = document.getElementById('round-select');

      // 1) Apply comp from URL if valid, else first option
      const compOptions = Array.from(compSel.options).map(o => o.value);
      if (comp && compOptions.includes(comp)) compSel.value = comp;
      if (!compSel.value && compOptions.length) compSel.value = compOptions[0];

      // 2) Populate rounds for selected comp
      populateRounds(); // must build roundSel options from master for compSel.value

      // 3) Apply round from URL if valid, else first option
      const roundOptions = Array.from(roundSel.options).map(o => o.value);
      if (round && roundOptions.includes(round)) roundSel.value = round;
      if (!roundSel.value && roundOptions.length) roundSel.value = roundOptions[0];

      // 4) Update state + subtitle
      currentComp = compSel.value || '';
      currentRound = roundSel.value || '';
      document.getElementById('subtitle').textContent =
        currentRound ? `${currentRound}` : currentComp;
      updateTitles(); 

      // 5) Ensure URL reflects final state and load data when ready
      syncURLWithState();
      if (currentComp && currentRound) loadLeaderboard();
    }

    // ===== Render (route entry) =====
    async function render() {
      const route = getRoute();
      if (route.isLive) {
        showView('live');
        await initLiveOnce();
        applyURLToUIAndData();
      }
      else if (route.isEvents) {
        showView('events');
        renderEventsView();
      }
      else {
        showView('home');
      }
    }

    // —— Static events data ——  
    const eventsList = [
      {
        id: 'autumn-open',
        title: 'LSC Autumn Open',
        venue: 'HK Science Park',
        date:  'Oct 5, 2025',
        time:  '10:00 AM',
        info:  'A fun open competition hosted at Science Park. All levels welcome!'
      },
      {
        id: 'speedcubing-challenge',
        title: 'LSC Speedcubing Challenge',
        venue: 'City Hall',
        date:  'Nov 12, 2025',
        time:  '2:00 PM',
        info:  'Test your single-solve speed under pressure. Prizes for top 3!'
      },
      {
        id: 'winter-invitational',
        title: 'LSC Winter Invitational',
        venue: 'PolyU Campus',
        date:  'Dec 20, 2025',
        time:  '11:00 AM',
        info:  'Invitation event for top regional cubers. Spectators welcome.'
      }
    ];

    // —— Render the list of events ——  
    function renderEventsView() {
      const listEl    = document.getElementById('events-list');
      const detailsEl = document.getElementById('event-details');
      detailsEl.style.display = 'none';
      detailsEl.innerHTML     = '';
      listEl.innerHTML        = '';

      eventsList.forEach(evt => {
        const li = document.createElement('li');
        li.textContent = evt.title;
        li.style.cursor = 'pointer';
        li.style.padding = '12px 16px';
        li.style.marginBottom = '8px';
        li.style.background = 'white';
        li.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
        li.onclick = () => showEventDetails(evt.id);
        listEl.appendChild(li);
      });
    }

    // —— Show one event’s details ——  
    function showEventDetails(id) {
      const evt = eventsList.find(e => e.id === id);
      if (!evt) return;
      const d = document.getElementById('event-details');
      d.innerHTML = `
        <h3 style="margin-top:0;">${evt.title}</h3>
        <p><strong>Venue:</strong> ${evt.venue}</p>
        <p><strong>Date:</strong> ${evt.date}</p>
        <p><strong>Time:</strong> ${evt.time}</p>
        <p>${evt.info}</p>
      `;
      d.style.display = 'block';
    }

    // ===== Global dropdown handlers (single source of truth) =====
    document.getElementById('comp-select').onchange = () => {
      populateRounds(); // rebuild round options for selected comp
      const roundSel = document.getElementById('round-select');

      currentComp  = document.getElementById('comp-select').value || '';
      currentRound = roundSel.value || '';

      // Update subtitle immediately so it’s visible during loading
      document.getElementById('subtitle').textContent =
        currentRound ? `${currentRound}` : currentComp;

      syncURLWithState();
      if (currentComp && currentRound) loadLeaderboard();
    };

    document.getElementById('round-select').onchange = () => {
      currentComp  = document.getElementById('comp-select').value || '';
      currentRound = document.getElementById('round-select').value || '';

      document.getElementById('subtitle').textContent = `${currentRound}`;

      syncURLWithState();
      if (currentComp && currentRound) loadLeaderboard();
    };

    // ===== Leaderboard loader (disables selects + loading message + aborts stale) =====
    async function loadLeaderboard(silent = false) {
      if (!currentComp || !currentRound) return;

      // Abort any in-flight request when a new one starts (prevents “haywire”)
      if (currentFetchAbort) currentFetchAbort.abort();
      const controller = new AbortController();
      currentFetchAbort = controller;

      const compSel    = document.getElementById('comp-select');
      const roundSel   = document.getElementById('round-select');
      const loadingMsg = document.getElementById('loading-message');

      if (!silent) { // Lock UI while loading
        compSel.disabled  = true;
        roundSel.disabled = true;
        if (loadingMsg) {
          loadingMsg.textContent = 'Loading...';
          loadingMsg.style.display = 'block';
        }
      }

      try {
        const url = `${READ_ENDPOINT}?comp=${encodeURIComponent(currentComp)}&round=${encodeURIComponent(currentRound)}&public=true&format=json`;
        const res = await fetch(url, { method: 'GET', redirect: 'follow', signal: controller.signal });
        const json = await res.json();

        if (!json || !json.headers) {
          renderEmpty();
        } else {
          renderLeaderboard(json.headers, json.rows || []);
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('Failed to load leaderboard:', err);
          if (loadingMsg) loadingMsg.textContent = 'Failed to load leaderboard.';
        }
      } finally {
        if (!silent) { // small delay avoids flicker on fast responses
          setTimeout(() => {
            if (loadingMsg) loadingMsg.style.display = 'none';
            compSel.disabled  = false;
            roundSel.disabled = false;
          }, 150);
        }
      }
    }

    function renderEmpty() {
      const thead = document.querySelector('#leaderboard thead');
      const tbody = document.querySelector('#leaderboard tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
    }

    // ===== Leaderboard renderer (rounding + header alignment) =====
    function renderLeaderboard(headers, rows) {
      const thead = document.querySelector('#leaderboard thead');
      const tbody = document.querySelector('#leaderboard tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      const floorCols = new Set(['1','2','3','4','5','Best']);
      const numRegex = /^-?\d+(\.\d+)?$/;

      // Build header row with alignment
      const headerRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;

        const key = h.toLowerCase();
        if (key === 'rank' || key === 'number')      th.style.textAlign = 'center';
        else if (key === 'name' || key === 'class')  th.style.textAlign = 'left';
        else                                         th.style.textAlign = 'right';

        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Build body rows
      rows.forEach((rowObj, rowIndex) => {
        const tr = document.createElement('tr');
        headers.forEach((h, colIdx) => {
          const td = document.createElement('td');
          let cell = (rowObj[h] ?? '').toString().trim();

          // Only transform pure numeric cells; leave "DNF"/"DNS" etc. intact
          if (numRegex.test(cell)) {
            const num = parseFloat(cell);
            if (h === 'Average') {
              cell = num.toFixed(2); // normal rounding
            } else if (floorCols.has(h)) {
              const floored = Math.floor(num * 100) / 100; // floor at 2dp
              cell = floored.toFixed(2);
            }
          }

          td.textContent = cell;

          // Align data cells to match header
          const key = h.toLowerCase();
          if (key === 'rank' || key === 'number') {
            td.style.textAlign = 'center';
          } else if (key === 'name') {
            td.style.textAlign = 'left';
            td.style.color     = '#1976D2';
            td.style.fontWeight= 'normal';
          } else if (key === 'class') {
            td.style.textAlign = 'left';
          } else {
            td.style.textAlign = 'right';
          }

          // Highlight top 3 ranks in first column
          if (rowIndex < 3 && colIdx === 0) {
            td.style.backgroundColor = '#00e676';
          }

          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // ===== Private editor: load CSV for inputs (reuse parser) =====
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let value = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { value += '"'; i++; }
            else { inQuotes = false; }
          } else { value += c; }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') { row.push(value); value = ''; }
          else if (c === '\n' || c === '\r') {
            if (c === '\r' && text[i + 1] === '\n') i++;
            row.push(value); value = '';
            rows.push(row); row = [];
          } else { value += c; }
        }
      }
      if (value.length > 0 || row.length > 0) { row.push(value); rows.push(row); }
      return rows.filter(r => r.length > 0);
    }

    function loadEditableSheet() {
      document.getElementById('leaderboard').style.display = 'none';
      if (!currentComp || !currentRound) return;

      const privateUrl = `${READ_ENDPOINT}?comp=${encodeURIComponent(currentComp)}&round=${encodeURIComponent(currentRound)}&public=false&format=csv`;

      fetch(privateUrl)
        .then(res => res.text())
        .then(text => {
          const rows = parseCSV(text.trim());
          const headers = rows[0] || [];
          const thead = document.querySelector('#edit-table thead');
          const tbody = document.querySelector('#edit-table tbody');

          thead.innerHTML = '';
          tbody.innerHTML = '';

          // Show columns with indices 2 through 10
          const visibleIndices = Array.from({ length: 9 }, (_, i) => i + 2); // [2..10]
          const editableIndices = visibleIndices.filter(i => i >= 6);       // [6..10]

          const headerRow = document.createElement('tr');
          visibleIndices.forEach(i => {
            const th = document.createElement('th');
            th.textContent = headers[i] ?? `Col ${i + 1}`;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          rows.slice(1).forEach(row => {
            const tr = document.createElement('tr');
            visibleIndices.forEach(i => {
              const td = document.createElement('td');
              const value = (row[i] ?? '').trim();
              if (editableIndices.includes(i)) {
                const input = document.createElement('input');
                input.value = value;
                input.setAttribute('data-col-index', i.toString());
                td.appendChild(input);
              } else {
                td.textContent = value;
              }
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          document.getElementById('submit-status').textContent = "Error loading private sheet: " + err.message;
          document.getElementById('submit-status').style.display = 'block';
          setTimeout(() => {
            document.getElementById('submit-status').style.display = 'none';
          }, 3000);
        });
    }

    async function submitEdits() {
      const table = document.querySelector('#edit-table');
      const rows  = Array.from(table.rows).slice(1);
      const data = rows.map(row => {
        return Array.from(row.cells)
          .map(cell => {
            const input = cell.querySelector('input');
            if (input) {
              return {
                colIndex: parseInt(input.getAttribute('data-col-index'), 10),
                value: input.value
              };
            }
            return null;
          })
          .filter(cell => cell !== null);
      });

      const payload = { comp: currentComp, round: currentRound, data };

      fetch(WRITE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(msg => {
        const text = msg.status
          ? `Submitted: ${msg.status} (${msg.rows || 0} rows)`
          : `Error: ${JSON.stringify(msg)}`;
        document.getElementById('submit-status').textContent = text;
        document.getElementById('submit-status').style.color = msg.status ? 'green' : 'red';
      })
      .catch(err => {
        document.getElementById('submit-status').textContent = `Fetch error: ${err.message}`;
        document.getElementById('submit-status').style.color = 'red';
      });

      document.getElementById('editor-panel').style.display = 'none';
      document.getElementById('submit-status').style.display = 'block';
      loadLeaderboard();

      document.getElementById('leaderboard').style.display = 'table';
      document.getElementById('dropdown-container').style.display = 'block';
      setTimeout(() => {
        document.getElementById('submit-status').style.display = 'none';
      }, 3000);
    }

    function cancelEdit() {
      document.getElementById('editor-panel').style.display = 'none';
      document.getElementById('leaderboard').style.display = 'table';
      document.getElementById('dropdown-container').style.display = 'block';
      document.getElementById('submit-status').style.display = 'none';
    }

    // ===== Auto-refresh every 15s (only on Live) =====
    setInterval(() => {
      const liveVisible = !document.getElementById('view-live').hidden;
      if (liveVisible && currentComp && currentRound) loadLeaderboard({silent: true});
    }, 15000);

    // ===== Init =====
    window.onload = () => {
      render();
    };
  </script>

</body>
</html>
